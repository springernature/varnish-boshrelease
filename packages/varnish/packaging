set -e

VARNISH_VERSION=6.0.3

export PACKAGES=/var/vcap/packages

addBuildTool(){
  export PATH=$PACKAGES/$1/bin:$PATH
  export AL_OPTS="${AL_OPTS} -I${PACKAGES}/$1"
}

addLib(){
  export PATH=$PACKAGES/$1/bin:$PATH
  export PKG_CONFIG_PATH="${PACKAGES}/$1/lib/pkgconfig:${PKG_CONFIG_PATH}"
  export LDFLAGS="${LDFLAGS} -L${PACKAGES}/$1/lib"
  export CFLAGS="${CFLAGS} -I${PACKAGES}/$1/include"
}

setDeps() {
  addBuildTool autoconf
  addBuildTool automake
  addBuildTool libtool
  addBuildTool pkg-config

  addLib zlib
  addLib pcre
  addLib ncurses

  export ACLOCAL_PATH="${PACKAGES}/pkg-config/share/aclocal"
}

source /var/vcap/packages/python-2.7/bosh/compile.env
pip install docutils sphinx

mkdir ${BOSH_INSTALL_TARGET}/bin

tar xzf varnish/varnish-${VARNISH_VERSION}.tgz
pushd varnish-${VARNISH_VERSION}

  setDeps
  sh autogen.sh
  sh configure --prefix=${BOSH_INSTALL_TARGET}
  make
popd
